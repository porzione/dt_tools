#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative 'models'
require 'oj'

GEO = %i[longitude latitude altitude].freeze

data = {}

FilmRoll.order(:folder).all do |roll|
  d = roll[:folder]
  data[d] = {}
  Image
    .select(:id, :filename, :version, :write_timestamp, *GEO)
    .where(film_id: roll[:id])
    .order(:filename, :version)
    .each do |img|
    meta = {}
    geo = img.to_hash.slice(*GEO).values.select { |v| v }
    meta[:geo] = geo unless geo.empty?
    meta[:k] = MetaData
               .select(:key, :value)
               .where(id: img[:id])
               .map { |r| [r[:key], r[:value]] }.to_h
    meta[:t] = img[:write_timestamp]
    f = img[:filename]
    data[d][f] = {} unless data[d][f]
    data[d][f][ img[:version] ] = meta
    tids = TaggedImage
           .where(imgid: img[:id])
           .map { |t| t[:tagid] }
    tags = UsedTag
           .where(id: tids)
           .map { |t| t[:name] }
           .reject { |t| t.match?(/^darktable\|.+/) }
    data[d][f][ img[:version] ][:tags] = tags unless tags.empty?
  end
end

puts Oj.dump(data, indent: 2, mode: :compat)
