#!/usr/bin/env ruby
# frozen_string_literal: true

require 'oj'
require_relative 'models'

GEO = %i[longitude latitude altitude].freeze

data = {}

def get_tags(imgid)
  tids = TaggedImage
         .where(imgid: imgid)
         .select_map(:tagid)

  UsedTag
    .where(id: tids)
    .select_map(:name)
    .reject { |t| t.match?(/^darktable\|.+/) }
end

FilmRoll.order(:folder).all do |roll|
  d = roll.folder
  data[d] = {}
  Image
    .select(:id, :filename, :version, :write_timestamp, *GEO)
    .where(film_id: roll.id)
    .order(:filename, :version)
    .each do |img|
    meta = {}
    geo = img.to_hash.slice(*GEO).values.compact.map(&:to_s)
    meta[:geo] = geo unless geo.empty?
    meta[:k] = MetaData
               .where(id: img.id)
               .select_map(%i[key value])
               .to_h
    meta[:t] = img.write_timestamp
    f = img.filename
    data[d][f] = {} unless data[d][f]
    data[d][f][ img.version ] = meta
    tags = get_tags(img.id)
    data[d][f][img.version][:tags] = tags unless tags.empty?
  end
end

puts Oj.dump(data, indent: 2, mode: :compat)
